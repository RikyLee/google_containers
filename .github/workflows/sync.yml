name: sync k8s.gcr.io

on:
  push:
    branches: 
     - test
     - master
  pull_request:
    branches: [ master ]

jobs:
  build:
    name: Build
    env:
      DOCKER_PASS: ${{ secrets.DOCKER_PASS }} 
    runs-on: ubuntu-latest
    steps:

    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: ^1.15

    - name: Check out code into the Go module directory
      uses: actions/checkout@v2
    - name: install docker
      uses: docker-practice/actions-setup-docker@master

    - name: before_script
      run: |
        bash build/build.sh build
        bash .github/scripts/ci-before.sh
        ls -alh ${HOME}/sync/
        ${HOME}/sync/imgsync sum ${HOME}/sync/bolt.db | wc -l
      env:
        CGO_ENABLED: 0
    - name: script
      id: sync
      continue-on-error: true
      run: |
        ls -l
    - name: Dump steps context
      env:
        STEPS_CONTEXT: ${{ toJson(steps) }}
      run: echo "$STEPS_CONTEXT"
      
    - name: after_success
      run: |
        bash .github/scripts/ci-after.sh
        ls -alh ${HOME}/sync/
        ${HOME}/sync/imgsync sum ${HOME}/sync/bolt.db | wc -l
      if: ${{ steps.sync.success() }}
    - name: after_failure
      run: |
        bash .github/scripts/ci-after.sh
        ls -alh ${HOME}/sync/
      if: "!${{ steps.sync.success() }}"
